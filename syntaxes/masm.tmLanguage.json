{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "MASM",
  "scopeName": "source.masm",
  "patterns": [
    { "include": "#comments" },
    { "include": "#annotations" },
    { "include": "#procedures" },
    { "include": "#begin-block" },
    { "include": "#imports" },
    { "include": "#constants-def" },
    { "include": "#control-flow" },
    { "include": "#instructions" },
    { "include": "#strings" },
    { "include": "#numbers" },
    { "include": "#constants" },
    { "include": "#operators" },
    { "include": "#punctuation" }
  ],
  "repository": {
    "comments": {
      "patterns": [
        {
          "name": "comment.block.documentation.masm",
          "match": "#!.*$"
        },
        {
          "name": "comment.line.number-sign.masm",
          "match": "#.*$"
        }
      ]
    },
    "annotations": {
      "patterns": [
        {
          "name": "meta.annotation.masm",
          "begin": "(@)(\\w+)",
          "beginCaptures": {
            "1": { "name": "punctuation.definition.annotation.masm" },
            "2": { "name": "entity.name.function.decorator.masm" }
          },
          "end": "(?=\\s|$|@|proc|pub)",
          "patterns": [
            {
              "begin": "\\(",
              "beginCaptures": {
                "0": { "name": "punctuation.brackets.round.masm" }
              },
              "end": "\\)",
              "endCaptures": {
                "0": { "name": "punctuation.brackets.round.masm" }
              },
              "patterns": [
                { "include": "#strings" },
                { "include": "#numbers" },
                {
                  "name": "variable.parameter.masm",
                  "match": "\\b[a-zA-Z_][a-zA-Z0-9_]*\\b"
                },
                {
                  "name": "punctuation.separator.comma.masm",
                  "match": ","
                }
              ]
            }
          ]
        }
      ]
    },
    "procedures": {
      "patterns": [
        {
          "name": "meta.procedure.masm",
          "begin": "\\b(pub\\s+)?(proc)\\s+([a-zA-Z_][a-zA-Z0-9_]*)",
          "beginCaptures": {
            "1": { "name": "keyword.other.visibility.masm" },
            "2": { "name": "keyword.declaration.procedure.masm" },
            "3": { "name": "entity.name.function.masm" }
          },
          "end": "\\b(end)\\b",
          "endCaptures": {
            "1": { "name": "keyword.control.end.masm" }
          },
          "patterns": [
            { "include": "#proc-signature" },
            { "include": "#proc-body" }
          ]
        }
      ]
    },
    "proc-signature": {
      "patterns": [
        {
          "name": "meta.parameters.masm",
          "begin": "\\(",
          "beginCaptures": {
            "0": { "name": "punctuation.brackets.round.masm" }
          },
          "end": "\\)",
          "endCaptures": {
            "0": { "name": "punctuation.brackets.round.masm" }
          },
          "patterns": [
            {
              "comment": "Parameter with direction modifier and pointer type: in a_0: *felt",
              "match": "\\b(in|out|inout)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*(:)\\s*(\\*)?([a-zA-Z_][a-zA-Z0-9_]*)",
              "captures": {
                "1": { "name": "storage.modifier.masm" },
                "2": { "name": "variable.parameter.masm" },
                "3": { "name": "punctuation.separator.colon.masm" },
                "4": { "name": "keyword.operator.pointer.masm" },
                "5": { "name": "entity.name.type.masm" }
              }
            },
            {
              "comment": "Parameter with direction modifier, no type: in a_0",
              "match": "\\b(in|out|inout)\\s+([a-zA-Z_][a-zA-Z0-9_]*)(?!\\s*:)",
              "captures": {
                "1": { "name": "storage.modifier.masm" },
                "2": { "name": "variable.parameter.masm" }
              }
            },
            {
              "comment": "Parameter with pointer type, no direction: a_0: *felt",
              "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(:)\\s*(\\*)([a-zA-Z_][a-zA-Z0-9_]*)",
              "captures": {
                "1": { "name": "variable.parameter.masm" },
                "2": { "name": "punctuation.separator.colon.masm" },
                "3": { "name": "keyword.operator.pointer.masm" },
                "4": { "name": "entity.name.type.masm" }
              }
            },
            {
              "comment": "Parameter with type, no direction: a_0: felt",
              "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(:)\\s*([a-zA-Z_][a-zA-Z0-9_]*)",
              "captures": {
                "1": { "name": "variable.parameter.masm" },
                "2": { "name": "punctuation.separator.colon.masm" },
                "3": { "name": "entity.name.type.masm" }
              }
            },
            {
              "comment": "Standalone parameter name (no type annotation)",
              "match": "\\b([a-zA-Z_][a-zA-Z0-9_]*)\\b(?!\\s*:)",
              "captures": {
                "1": { "name": "variable.parameter.masm" }
              }
            },
            {
              "name": "punctuation.separator.comma.masm",
              "match": ","
            }
          ]
        },
        {
          "name": "meta.return-type.masm",
          "begin": "(->)",
          "beginCaptures": {
            "1": { "name": "punctuation.arrow.masm" }
          },
          "end": "(?=\\s*(?:#|$|[a-z]))",
          "patterns": [
            { "include": "#return-values" }
          ]
        }
      ]
    },
    "return-values": {
      "patterns": [
        {
          "comment": "Parenthesized return values: (r_0: felt, r_1: *felt)",
          "begin": "\\(",
          "beginCaptures": {
            "0": { "name": "punctuation.brackets.round.masm" }
          },
          "end": "\\)",
          "endCaptures": {
            "0": { "name": "punctuation.brackets.round.masm" }
          },
          "patterns": [
            {
              "comment": "Return value with pointer type: r_0: *felt",
              "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(:)\\s*(\\*)([a-zA-Z_][a-zA-Z0-9_]*)",
              "captures": {
                "1": { "name": "variable.parameter.masm" },
                "2": { "name": "punctuation.separator.colon.masm" },
                "3": { "name": "keyword.operator.pointer.masm" },
                "4": { "name": "entity.name.type.masm" }
              }
            },
            {
              "comment": "Return value with type: r_0: felt",
              "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(:)\\s*([a-zA-Z_][a-zA-Z0-9_]*)",
              "captures": {
                "1": { "name": "variable.parameter.masm" },
                "2": { "name": "punctuation.separator.colon.masm" },
                "3": { "name": "entity.name.type.masm" }
              }
            },
            {
              "comment": "Question mark for unknown return type",
              "name": "keyword.operator.unknown.masm",
              "match": "\\?"
            },
            {
              "name": "punctuation.separator.comma.masm",
              "match": ","
            }
          ]
        },
        {
          "comment": "Single return type (unparenthesized): -> felt or -> *felt",
          "match": "(\\*)?([a-zA-Z_][a-zA-Z0-9_]*)",
          "captures": {
            "1": { "name": "keyword.operator.pointer.masm" },
            "2": { "name": "entity.name.type.masm" }
          }
        }
      ]
    },
    "proc-body": {
      "patterns": [
        { "include": "#comments" },
        { "include": "#control-flow" },
        { "include": "#instructions" },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#constants" },
        { "include": "#operators" },
        { "include": "#punctuation" }
      ]
    },
    "begin-block": {
      "patterns": [
        {
          "name": "meta.begin-block.masm",
          "begin": "\\b(begin)\\b",
          "beginCaptures": {
            "1": { "name": "keyword.control.begin.masm" }
          },
          "end": "\\b(end)\\b",
          "endCaptures": {
            "1": { "name": "keyword.control.end.masm" }
          },
          "patterns": [
            { "include": "#proc-body" }
          ]
        }
      ]
    },
    "imports": {
      "patterns": [
        {
          "name": "meta.import.masm",
          "match": "\\b(pub\\s+)?(use)\\s+([a-zA-Z_][a-zA-Z0-9_]*(?:::[a-zA-Z_][a-zA-Z0-9_]*)*)(?:\\s*(->)\\s*([a-zA-Z_][a-zA-Z0-9_]*))?",
          "captures": {
            "1": { "name": "keyword.other.visibility.masm" },
            "2": { "name": "keyword.control.import.masm" },
            "3": { "name": "entity.name.namespace.masm" },
            "4": { "name": "punctuation.arrow.masm" },
            "5": { "name": "entity.name.namespace.alias.masm" }
          }
        }
      ]
    },
    "constants-def": {
      "patterns": [
        {
          "name": "meta.constant.masm",
          "begin": "\\b(pub\\s+)?(const)\\s+([A-Z][A-Z0-9_]*)\\s*(=)",
          "beginCaptures": {
            "1": { "name": "keyword.other.visibility.masm" },
            "2": { "name": "keyword.declaration.constant.masm" },
            "3": { "name": "variable.other.constant.masm" },
            "4": { "name": "keyword.operator.assignment.masm" }
          },
          "end": "(?=\\s*(?:#|$|pub|const|use|proc|begin|@))",
          "patterns": [
            {
              "name": "meta.event-call.masm",
              "match": "\\b(event)\\s*\\(\\s*(\"[^\"]*\")\\s*\\)",
              "captures": {
                "1": { "name": "support.function.builtin.masm" },
                "2": { "name": "string.quoted.double.masm" }
              }
            },
            { "include": "#strings" },
            { "include": "#numbers" },
            { "include": "#constants" },
            { "include": "#operators" },
            { "include": "#punctuation" }
          ]
        }
      ]
    },
    "control-flow": {
      "patterns": [
        {
          "name": "keyword.control.conditional.masm",
          "match": "\\b(if)\\.(true|false)\\b",
          "captures": {
            "1": { "name": "keyword.control.conditional.masm" },
            "2": { "name": "constant.language.boolean.masm" }
          }
        },
        {
          "name": "keyword.control.loop.masm",
          "match": "\\b(while)\\.(true)\\b",
          "captures": {
            "1": { "name": "keyword.control.loop.masm" },
            "2": { "name": "constant.language.boolean.masm" }
          }
        },
        {
          "name": "keyword.control.loop.masm",
          "match": "\\b(repeat)\\.([0-9]+)\\b",
          "captures": {
            "1": { "name": "keyword.control.loop.masm" },
            "2": { "name": "constant.numeric.decimal.masm" }
          }
        },
        {
          "name": "keyword.control.masm",
          "match": "\\b(else|end)\\b"
        }
      ]
    },
    "instructions": {
      "patterns": [
        {
          "comment": "Dotted instruction with path (exec, call, syscall, procref)",
          "match": "\\b(exec|call|syscall|procref)\\.([a-zA-Z_][a-zA-Z0-9_]*(?:::[a-zA-Z_][a-zA-Z0-9_]*)*)\\b",
          "captures": {
            "1": { "name": "keyword.operator.instruction.masm" },
            "2": { "name": "entity.name.function.call.masm" }
          }
        },
        {
          "comment": "Debug instruction with operand",
          "match": "\\b(debug)\\.(stack|mem|local|adv_stack)(?:\\.([0-9]+))?\\b",
          "captures": {
            "1": { "name": "keyword.operator.instruction.masm" },
            "2": { "name": "support.constant.debug-target.masm" },
            "3": { "name": "constant.numeric.decimal.masm" }
          }
        },
        {
          "comment": "Assert with error code",
          "match": "\\b(assert|assertz|assert_eq|assert_eqw)\\.(err)\\s*(=)\\s*(?:(\"[^\"]*\")|([A-Z][A-Z0-9_]*))",
          "captures": {
            "1": { "name": "keyword.operator.instruction.masm" },
            "2": { "name": "support.constant.masm" },
            "3": { "name": "keyword.operator.assignment.masm" },
            "4": { "name": "string.quoted.double.masm" },
            "5": { "name": "variable.other.constant.masm" }
          }
        },
        {
          "comment": "Dotted instruction with values (push, dup, etc.)",
          "match": "\\b(push|dup|dupw|swap|swapw|movup|movupw|movdn|movdnw|add|sub|mul|div|exp|eq|neq|lt|lte|gt|gte|u32wrapping_add|u32wrapping_sub|u32wrapping_mul|u32overflowing_add|u32overflowing_sub|u32overflowing_mul|u32div|u32mod|u32divmod|u32and|u32or|u32xor|u32shl|u32shr|u32rotl|u32rotr|mem_load|mem_store|mem_loadw|mem_storew|mem_loadw_be|mem_loadw_le|mem_storew_be|mem_storew_le|loc_load|loc_store|loc_loadw|loc_storew|loc_loadw_be|loc_loadw_le|loc_storew_be|loc_storew_le|locaddr|adv_push|adv|assert|assertz|assert_eq|assert_eqw|emit|trace|u)\\.(?=[-0-9a-fA-FxA-Z])",
          "captures": {
            "1": { "name": "keyword.operator.instruction.masm" }
          }
        },
        {
          "comment": "Simple instructions (no dot suffix required)",
          "name": "keyword.operator.instruction.masm",
          "match": "\\b(nop|drop|dropw|padw|dup|dupw|swap|swapw|swapdw|add|sub|mul|div|neg|inv|and|or|xor|not|eq|neq|lt|lte|gt|gte|eqw|hash|hperm|hmerge|caller|clk|sdepth|assert|assertz|assert_eq|assert_eqw|u32test|u32testw|u32cast|u32split|u32and|u32or|u32xor|u32not|u32shl|u32shr|u32rotl|u32rotr|u32lt|u32lte|u32gt|u32gte|u32min|u32max|u32wrapping_add|u32wrapping_sub|u32wrapping_mul|u32overflowing_add|u32overflowing_sub|u32overflowing_mul|u32overflowing_add3|u32overflowing_madd|u32wrapping_add3|u32wrapping_madd|u32div|u32mod|u32divmod|u32assert2|u32popcnt|u32clz|u32ctz|u32clo|u32cto|mem_load|mem_store|mem_loadw|mem_storew|mem_loadw_be|mem_loadw_le|mem_storew_be|mem_storew_le|mem_stream|loc_load|loc_store|loc_loadw|loc_storew|loc_loadw_be|loc_loadw_le|loc_storew_be|loc_storew_le|adv_loadw|adv_pipe|mtree_get|mtree_set|mtree_merge|mtree_verify|ext2add|ext2sub|ext2mul|ext2div|ext2neg|ext2inv|fri_ext2fold4|emit|trace|dyncall|dynexec|breakpoint|cdrop|cdropw|cswap|cswapw|pow2|ilog2|is_odd|exp|reversew|log_precompile|movup|movdn|movupw|movdnw)\\b"
        },
        {
          "comment": "Boolean literals as instruction operands",
          "name": "constant.language.boolean.masm",
          "match": "\\b(true|false)\\b"
        }
      ]
    },
    "strings": {
      "patterns": [
        {
          "name": "string.quoted.double.masm",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.masm",
              "match": "\\\\."
            }
          ]
        }
      ]
    },
    "numbers": {
      "patterns": [
        {
          "name": "constant.numeric.hexadecimal.masm",
          "match": "\\b0x[0-9a-fA-F]+\\b"
        },
        {
          "name": "constant.numeric.decimal.masm",
          "match": "\\b[0-9]+\\b"
        }
      ]
    },
    "constants": {
      "patterns": [
        {
          "name": "variable.other.constant.masm",
          "match": "\\b[A-Z][A-Z0-9_]*\\b"
        }
      ]
    },
    "operators": {
      "patterns": [
        {
          "name": "keyword.operator.namespace.masm",
          "match": "::"
        },
        {
          "name": "keyword.operator.arrow.masm",
          "match": "->"
        },
        {
          "name": "keyword.operator.arithmetic.masm",
          "match": "\\+|-|\\*|/(?!/)|//"
        },
        {
          "name": "keyword.operator.assignment.masm",
          "match": "="
        },
        {
          "name": "keyword.operator.accessor.masm",
          "match": "\\."
        }
      ]
    },
    "punctuation": {
      "patterns": [
        {
          "name": "punctuation.brackets.round.masm",
          "match": "[()]"
        },
        {
          "name": "punctuation.separator.colon.masm",
          "match": ":"
        },
        {
          "name": "punctuation.separator.comma.masm",
          "match": ","
        }
      ]
    }
  }
}
